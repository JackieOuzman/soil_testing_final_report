---
title: "Summary for final report"
author: "Jackie Ouzman"
date: "08/09/2021"
output: html_document
---
```{r load library, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(ggplot2)

library(formattable)
library(sf)
library(readxl)


library(gt)
library(glue)


library(rnaturalearth)


library(readr)

library(DT)
library(plotKML)
library(knitr)
library(png)


library(magick)


```

## Number of N and P trials for 2020 -2021  season 

CSIRO team have been supplied with spatial data for the location of strip trials.
Along with this information we have details on the type of trial (either N or P) and the fertilisers used.



Note that a few paddocks have both N and P trials.



Most paddocks have two zone, but some have just one and some have multiple zone.
This is filtering data out that is marked excluded from analysis and ensured I am only keeping unique Zone ID.

```{r zone shapefile 2020, message=TRUE, warning=FALSE, include=FALSE}
zone2020 <- st_read("W:/value_soil_testing_prj/Yield_data/2020/All_Zones_2020_wgs84.shp")


zone2020_df <- data.frame(zone2020)
zone2020_1 <- zone2020_df %>% dplyr::select(-geometry)


## some paddocks are excluded from the analysis
zone2020_df <- zone2020_1 %>% 
  filter(Status != "Excluded from Analysis")
#just keep a few clms
names(zone2020_df)
zone2020_df <- zone2020_df %>% 
  dplyr::select(Zone_ID,
                Strip_Type,
                Status,
                organisati,
                contact, 
                farmer,
                paddock)
rm(zone2020, zone2020_1)


zone2020_unique <- zone2020_df %>% 
  distinct(Zone_ID, Strip_Type, .keep_all = TRUE)

#how many zones with N / P strips?
zone2020_count <- zone2020_unique %>% 
  distinct(Zone_ID, .keep_all = TRUE) %>%
  group_by(Strip_Type) %>% 
  summarise(count_zones_by_type = n())



```

2020 season. Zone per fertilsier strip type (using zone shapefile).

```{r  numb strip trials, echo=FALSE, message=TRUE, warning=FALSE}

zone2020_count

```

2020 season.Paddocks per fertilsier strip type.

```{r zone 2020 per paddock, message=TRUE, warning=FALSE, include=FALSE}
#how many paddocks with N / P strips?

names(zone2020_unique)
#I cant just select paddock names beacuse some have the same name house and creek

zone_paddocks <- zone2020_unique %>%
  dplyr::mutate(paddock_farmer = paste0(paddock, "_", farmer)) %>% 
  dplyr::distinct(paddock_farmer, Strip_Type, .keep_all = TRUE)
  
zone_paddocks 
 
count_paddock <- zone_paddocks %>% 
  group_by(Strip_Type) %>% 
  summarise(count_paddocks_by_type = n())

```


```{r  numb paddocks, echo=FALSE, message=TRUE, warning=FALSE}

count_paddock


```


2020 season. How many growers?

```{r zone 2020 per farmers, message=TRUE, warning=FALSE, include=FALSE}

farmers_dist <- zone2020_unique %>% 
  dplyr::distinct(farmer,Strip_Type, .keep_all = TRUE)

farmers_count_type <- farmers_dist %>% 
    group_by(Strip_Type) %>% 
  summarise(count_farmers_by_type = n())

farmers_count <- farmers_dist %>% 
    summarise(count_farmers_by_type = n())



```

```{r number of farmers 2020, echo=FALSE, message=TRUE, warning=FALSE}
farmers_count
```


I can run the same analysis with the strip files but the numbers are slightly different because of the trials that have N and P.
So I will use the zone shapefile as a basis.
The code is here but I am not displaying the output.


```{r load_data1, message=TRUE, warning=FALSE, include=FALSE}

#note that this script runs off the shapefile and has on intermediate steps


spatial_data_no_yld <- st_read("W:/value_soil_testing_prj/Yield_data/2020/All_Strips_2020_wgs84.shp")

spatial <-  st_as_sf(spatial_data_no_yld, coords = c("X", "Y"), crs = 4326) #this is for map in later code chuck

spatial_data_no_yld_df <- data.frame(spatial_data_no_yld)
spatial_data_no_yld_df_1 <- spatial_data_no_yld_df %>% dplyr::select(-geometry)

## some paddocks are excluded from the analysis
spatial_data_no_yld_df <- spatial_data_no_yld_df_1 %>% 
   filter(Status != "Excluded from Analysis")

spatial_data_no_yld_df <- spatial_data_no_yld_df %>% 
  dplyr::mutate(ID_Rate_GSP_type = paste0(Paddock_ID, "-", Rate, "-", GSP,"-",Strip_Type ),
         ID_trial_type = paste0(Paddock_ID, "-",Strip_Type))

spatial_data_no_yld_df <-spatial_data_no_yld_df %>% 
  dplyr::mutate(Alt_GSP = ifelse(stringr::str_detect(GSP_list, "Alt GSP"), "Alt_GPS", "No_Alt_GSP"))

rm(spatial_data_no_yld_df_1)

strips_distinct_paddockID <- spatial_data_no_yld_df %>% 
  distinct(Paddock_ID, Strip_Type, .keep_all = TRUE)

```

```{r plot numb trials, message=TRUE, warning=FALSE, include=FALSE}
plot1 <-
  dplyr::distinct(strips_distinct_paddockID, Paddock_ID ,Strip_Type, .keep_all = TRUE) %>%
  dplyr::select(Paddock_ID, Strip_Type, Alt_GSP) %>%
  ggplot(aes(Strip_Type)) +
  geom_bar() +
  theme_bw() +
  geom_text(aes(y = ((..count..)), label = ((..count..))), stat = "count", vjust = -0.25) +
  labs(
    title = "Number of P and N trials. 2020 to 2021 season",
    y = "Count",
    x = "Type of trial",
    subtitle = paste0("Total number of paddocks = ", count(
      distinct(spatial_data_no_yld_df, ID_trial_type)
    ))
  )
plot1


```




## Number of N and P trials for 2019 -2020  season 

```{r zone shapefile 2019, message=TRUE, warning=FALSE, include=FALSE}
zone2019 <- st_read("W:/value_soil_testing_prj/Yield_data/finished/GIS_Results/All_Zones_2019_wgs84.shp")


zone2019_df <- data.frame(zone2019)
zone2019_1 <- zone2019_df %>% dplyr::select(-geometry)


## some paddocks are excluded from the analysis

#just keep a few clms

zone2019_df <- zone2019_1 %>% 
  dplyr::select(Zone_ID,
                Strip_Type, # I need to add this in ??
                #Status,
                organisati,
                contact, 
                farmer,
                paddock)
rm(zone2019, zone2019_1)


zone2019_df_unique <- zone2019_df %>% 
  distinct(Zone_ID, Strip_Type, .keep_all = TRUE)

#how many zones with N / P strips?
zone2019_count <- zone2019_df_unique %>% 
  distinct(Zone_ID, .keep_all = TRUE) %>%
  group_by(Strip_Type) %>% 
  summarise(count_zones_by_type = n())



```

2019 season. Zone per fertilsier strip type (using zone shapefile).

```{r  numb strip trials 2019, echo=FALSE, message=TRUE, warning=FALSE}

zone2019_count

```

2019 season.Paddocks per fertilsier strip type.

```{r zone 2019 per paddock, message=TRUE, warning=FALSE, include=FALSE}
#how many paddocks with N / P strips?


zone_paddocks2019 <- zone2019_df_unique %>%
  dplyr::mutate(paddock_farmer = paste0(paddock, "_", farmer)) %>% 
  dplyr::distinct(paddock_farmer, Strip_Type, .keep_all = TRUE)

paddocks2019 <-  zone_paddocks2019 %>% 
  group_by(Strip_Type) %>% 
  summarise(count_paddocks_by_type = n())


```


```{r  numb paddocks 2019, echo=FALSE, message=TRUE, warning=FALSE}

paddocks2019

```


2019 season. How many growers?

```{r zone 2019 per farmers, message=TRUE, warning=FALSE, include=FALSE}


farmers_dist2019 <- zone2019_df_unique %>% 
  dplyr::distinct(farmer,Strip_Type, .keep_all = TRUE)

farmers_count_type2019 <- farmers_dist2019 %>% 
  group_by(Strip_Type) %>% 
  summarise(count_farmers_by_type = n())

farmers_count2019 <- farmers_dist2019 %>% 
  summarise(count_farmers = n())



```

```{r number of farmers 2019, echo=FALSE, message=TRUE, warning=FALSE}

farmers_count_type2019
farmers_count2019
```


## Recommended rates 2020 -2021  season


```{r stuff around getting recom rates just for our 2020 paddocks, message=TRUE, warning=FALSE, include=FALSE}

#########################################################################################################################################
## step 1 make a list of zone and a list of paddocks that will be included in the analysis 
#1b. zone codes
##########################################################################################################################################


zone2020 <- st_read("W:/value_soil_testing_prj/Yield_data/2020/All_Zones_2020_wgs84.shp")


zone2020_df <- data.frame(zone2020)
zone2020_1 <- zone2020_df %>% dplyr::select(-geometry)


## some paddocks are excluded from the analysis
zone2020_df <- zone2020_1 %>% 
  filter(Status != "Excluded from Analysis")
#just keep a few clms
names(zone2020_df)
zone2020_df <- zone2020_df %>% 
  dplyr::select(Zone_ID,
                Strip_Type,
                Status,
                organisati,
                contact, 
                farmer,
                paddock)
rm(zone2020, zone2020_1)


zone2020_unique <- zone2020_df %>% 
  distinct(Zone_ID, Strip_Type, .keep_all = TRUE)



rm(zone2020_df)

str(zone2020_unique)
zone2020_unique$length_zoneID <- nchar(zone2020_unique$Zone_ID)
zone2020_unique <- zone2020_unique %>% 
  mutate(Paddock_ID =   
           case_when(length_zoneID == 6 ~ substr(Zone_ID, start = 1, stop = 5),
                     length_zoneID == 7 ~ substr(Zone_ID, start = 1, stop = 6)))

list_of_paddocks_include <- unique(zone2020_unique$Paddock_ID)
list_of_zone_include <- (zone2020_unique$Zone_ID)
print(list_of_paddocks_include)
##########################################################################################################################################
# 2. Add rainfall data
##########################################################################################################################################

rainfall_fert <- read.csv("W:/value_soil_testing_prj/Yield_data/2020/processing/processing_files/step2_fert_app_all_steps.csv")


rainfall_fert <- rainfall_fert %>%
  dplyr::select(
    Paddock_ID,
    #Rate,
    GSP	,
    #Strip_Rate,
    #organisati,
    #contact	,
    #farmer	,
    #paddock,
    #Strip_Type,
    av_rain,
    #Total_sum_N_content,
    #Total_sum_P_content,
    #Status
  )


##### filter out the data so I just have what I will use for the economic analysis


rainfall_fert <- rainfall_fert %>% 
  filter(Paddock_ID %in% list_of_paddocks_include)


### need to remove the Alt GPS from the rainfall data                
rainfall_fert <- rainfall_fert %>%   
  filter(is.na(GSP) | GSP == "GSP")


str(zone2020_unique) 
zone2020_unique$Paddock_ID <- as.double(zone2020_unique$Paddock_ID)
str(rainfall_fert)
rain_zone2020 <- left_join(zone2020_unique, rainfall_fert, by = "Paddock_ID")

# some seem to have come through twice ?? remove the

rain_zone2020 <- rain_zone2020 %>%
  filter(Status == "5. Report Complete" )

rain_zone2020 <- rain_zone2020 %>% dplyr::select(-GSP)
# beacuse I used the rainfall data file I have all the strip per zone -
#so I just need to keep unique values for zone ID and strip type

rain_zone2020 <- rain_zone2020 %>% 
  distinct(Zone_ID , Strip_Type, .keep_all = TRUE)

rain_zone2020 <- rain_zone2020 %>% 
  dplyr::mutate(
    rainfall_class = case_when(
      av_rain<=350 ~ "low",
      av_rain >500 ~ "high",
      TRUE ~ "medium"))


#rm(rainfall_fert,zone2020_unique, GS_rates_3a_just_analysis)
##########################################################################################################################################
#4. Bring in Sean DB
##########################################################################################################################################

recom_rateDB <- read_excel( "W:/value_soil_testing_prj/Yield_data/2020/processing/GRDC 2020 Paddock Database_SA_VIC_May05 2021.xlsx")

# select only a few clms with recommedation 
recom_rateDB <- recom_rateDB %>% 
  dplyr::select(Zone_ID =    `Paddock code` ,
                p_rec =           `P rec`,
                n_rec_yld_low =   `N Rec (< 3 t/ha)` ,       
                n_rec_yld_med =   `N Rec (3-5 t/ha)` ,             
                n_rec_yld_high =  `N Rec (> 5 t/ha)`,
                SM_comment_Soil_N = `SM comment Soil N`,
                SM_comment_Soil_P = `SM comment Soil P`,
                SM_comment_Plant_Tissue = `SM comment Plant Tissue`
  ) 

recom_rateDB <-  dplyr::mutate(recom_rateDB,  maxN = apply(recom_rateDB[3:5], 1, max, na.rm = TRUE))


# remove redunant clm and replace inf
recom_rateDB <- recom_rateDB %>% 
  mutate(
    maxN = case_when(
      maxN >= 0 ~ maxN,
      TRUE ~ NA_real_
    )
  )


# recom_rateDB <-recom_rateDB %>%
#   dplyr::select(-n_rec_yld_low,
#                 -n_rec_yld_med,
#                 -n_rec_yld_high)



#just keep the data for the economic analysis
#now use this list to filter out my analysis...
recom_rateDB <- recom_rateDB %>% 
  filter(Zone_ID %in% list_of_zone_include)

recom_rateDB <- recom_rateDB %>%
  dplyr::select(
    "Zone_ID" ,
    "p_rec" ,
    "maxN" ,
    "n_rec_yld_low",
    "n_rec_yld_med" ,
    "n_rec_yld_high",
    "SM_comment_Soil_N",
    "SM_comment_Soil_P",
    "SM_comment_Plant_Tissue"
  )     



## join rec rates with zone rainfall data
str(rain_zone2020)
str(recom_rateDB)
recom_rateDB$Zone_ID <- as.double(recom_rateDB$Zone_ID)

rec_rate_2020 <- left_join(rain_zone2020,recom_rateDB )

rm(rain_zone2020, rainfall_fert, zone2020_unique, recom_rateDB,
   list_of_paddocks_include, list_of_zone_include)

```


For P trials in 2020
The number of paddocks with either 1, 2,3 zones
How many paddocks have a P rec rate in zone 1 vs zone 2 that is higher than 5 kg


```{r rec rates different in zone 2020 P , echo=FALSE, message=TRUE, warning=FALSE}

#### is the recommedations different?  ###

rec_rate_2020_P <- rec_rate_2020 %>%  dplyr::filter(Strip_Type == "P Strip" | Strip_Type == "N Strip, P Strip")
Zone_In_Paddocks_P <- rec_rate_2020_P %>%  group_by(Paddock_ID) %>% 
  summarise(count_zone = n(),
            max_P_rec = max(p_rec, na.rm = FALSE),
            min_P_rec = min(p_rec, na.rm = FALSE))

Zone_In_Paddocks_P <- Zone_In_Paddocks_P %>% 
  mutate(diff_P_rec_rate = max_P_rec - min_P_rec)

Zone_In_Paddocks_P <- Zone_In_Paddocks_P %>% 
  mutate(count_of_diff = case_when(
    count_zone >1 & diff_P_rec_rate >5 ~ 1,
    TRUE ~ 0))
Zone_In_Paddocks_P %>%  group_by(count_zone) %>% 
  summarise(sum_of_when_diff = sum(count_of_diff, na.rm = TRUE))

Zone_In_Paddocks_P %>%  
              summarise(sum_of_when_diff = sum(count_of_diff, na.rm = TRUE),
                        count =  n())


```

For N trials in 2020
The number of paddocks with either 1, 2,3 zones
How many paddocks have a P rec rate in zone 1 vs zone 2 that is higher than 10 kg

Note for the paddocks with the one than 2 zone I have just reported on the max difference.
For example what was the min and max recommedation.  


```{r rec rates different in zone 2020 N, echo=FALSE, message=TRUE, warning=FALSE}

#### is the recommedations different?  ###


rec_rate_2020$Strip_Type <- as.character(rec_rate_2020$Strip_Type)

rec_rate_2020_N <- rec_rate_2020 %>%  dplyr::filter(Strip_Type == "N Strip" | Strip_Type == "N Strip, P Strip" )


Zone_In_Paddocks_N <- rec_rate_2020_N %>%  group_by(Paddock_ID) %>% 
  summarise(count_zone = n(),
            max_N_rec = max(maxN, na.rm = FALSE),
            min_N_rec = min(maxN, na.rm = FALSE))

Zone_In_Paddocks_N <- Zone_In_Paddocks_N %>% 
  mutate(diff_N_rec_rate = max_N_rec - min_N_rec)

Zone_In_Paddocks_N <- Zone_In_Paddocks_N %>% 
  mutate(count_of_diff = case_when(
    count_zone >1 & diff_N_rec_rate >10 ~ 1,
    TRUE ~ 0))
Zone_In_Paddocks_N %>%  group_by(count_zone) %>% 
  summarise(sum_of_when_diff = sum(count_of_diff, na.rm = TRUE))

Zone_In_Paddocks_N %>%  
              summarise(sum_of_when_diff = sum(count_of_diff, na.rm = TRUE),
                        count =  n())

```

